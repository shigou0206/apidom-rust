# ğŸ§© å­—æ®µæ³¨å†Œä¸æ„å»ºè°ƒåº¦ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> ç›®æ ‡ï¼šæ„å»ºä¸€å¥—é€šç”¨ã€å£°æ˜å¼ã€å¯æ‰©å±•çš„ Apidom Element å­—æ®µæ³¨å†Œä¸æ„å»ºç³»ç»Ÿï¼Œæ”¯æŒå­—æ®µæå–ã€Fold å¤„ç†ã€schema æ¯”å¯¹ã€UI schema å¯¼å‡ºç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## âœ… ä¸€ã€èƒŒæ™¯ä¸åŠ¨æœº

å½“å‰åœ¨æ„å»º Apidom Elementï¼ˆå¦‚ Encodingã€Infoã€Header ç­‰ï¼‰æ—¶ï¼Œå­—æ®µå¤„ç†é€»è¾‘é‡‡ç”¨æ‰‹å·¥ matchï¼š

- å­—æ®µåŒ¹é…ç¡¬ç¼–ç ï¼›
- ç¼ºä¹å­—æ®µæ¸…å•ï¼›
- æ— æ³•ä¸ OpenAPI Schema æ ¡éªŒä¸€è‡´æ€§ï¼›
- ä¸ä¾¿äºç”Ÿæˆ UI schema æˆ–ç±»å‹å£°æ˜ï¼›
- ä¸åˆ©äºæ‰©å±•æˆ–æ¨¡å—åŒ–æ„å»ºã€‚

å› æ­¤éœ€è¦æ„å»ºä¸€å¥—ç»“æ„é©±åŠ¨çš„å­—æ®µæ³¨å†Œä¸è°ƒåº¦ç³»ç»Ÿï¼Œå®ç°è§£è€¦ã€è§„èŒƒã€è‡ªåŠ¨åŒ–ã€‚

---

## ğŸ¯ äºŒã€ç›®æ ‡èƒ½åŠ›æ¸…å•

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| âœ… å­—æ®µç»“æ„æå– | è‡ªåŠ¨ä» OpenAPI 3.1 schema AST ä¸­æå–å­—æ®µå®šä¹‰ |
| âœ… å­—æ®µæ³¨å†Œå£°æ˜ | ä¸ºæ¯ä¸ª Element æ³¨å†Œå­—æ®µåã€å¤„ç†å‡½æ•° |
| âœ… æ„å»ºè°ƒåº¦ | æ„å»ºå™¨ä¸­å­—æ®µè‡ªåŠ¨æ´¾å‘åˆ°å¤„ç†å™¨ |
| âœ… Fold é›†æˆ | å­—æ®µå€¼å¯é€šè¿‡ `Fold` æŠ˜å å™¨é¢„å¤„ç† |
| âœ… Schema æ¯”å¯¹ | è‡ªåŠ¨æ ¡éªŒæ³¨å†Œå­—æ®µæ˜¯å¦åŒ¹é… schema å®šä¹‰ |
| âœ… Fallback æ§åˆ¶ | æ ¹æ® schema ä¸­ `additionalProperties` æ§åˆ¶æœªçŸ¥å­—æ®µå¤„ç† |
| âœ… UI schema / DTO ç”Ÿæˆ | å¯å¯¼å‡ºå­—æ®µç»“æ„ç”¨äº UI æˆ–å¤šè¯­è¨€ç±»å‹å£°æ˜ |
| âœ… æ¨¡æ¿ç”Ÿæˆ | æ”¯æŒä» schema è‡ªåŠ¨ç”Ÿæˆå­—æ®µæ³¨å†Œæ¨¡æ¿ä»£ç 

---

## ğŸ—ï¸ ä¸‰ã€ç³»ç»Ÿæ¨¡å—ç»„æˆ

### 1. Schema è§£ææ¨¡å—

- `schema_loader.rs`: è¯»å–å¹¶è§£æ OpenAPI JSON Schema ä¸º Apidom `Element` AST
- `dereference_pass.rs`: è§£å¼•ç”¨ `$ref`ï¼Œç¡®ä¿å®Œæ•´ç»“æ„ç”¨äºæå–

### 2. å­—æ®µç»“æ„æå–æ¨¡å—

- `extract_fieldspecs(&Element) -> Vec<FieldSpec>`:
  - è§£æ `properties`ã€`required`ã€`patternProperties`
  - ç”Ÿæˆ `FieldSpec { name, type_hint, required, from_pattern }`

### 3. å­—æ®µæ³¨å†Œä¸å®æ¨¡å—

- `register_fixed_fields!` å®ï¼šæ³¨å†Œå­—æ®µåä¸å¯¹åº” handler
- `register_pattern_fields!` å®ï¼šæ³¨å†Œæ‰©å±•å­—æ®µï¼ˆå¦‚ `^x-`ï¼‰
- `FieldHandlerMap<T>` ç±»å‹ï¼š`HashMap<&str, FieldHandlerFn<T>>`

### 4. æ„å»ºå™¨æ´¾å‘é€»è¾‘

- `builder_dispatch.rs`ï¼šæ¥æ”¶ä¸€ä¸ªå­—æ®µåï¼Œæ ¹æ® handler map è‡ªåŠ¨è°ƒç”¨æ„å»ºé€»è¾‘
- æ”¯æŒ fallback åˆ†æ”¯ï¼ˆå¯è‡ªå®šä¹‰æ§åˆ¶ç­–ç•¥ï¼‰

### 5. Schema æ¯”å¯¹ä¸éªŒè¯å™¨æ¨¡å—

- `compare_field_specs(schema_fields, registered_fields)`
- å¯æ£€æµ‹ï¼šç¼ºå¤±å­—æ®µã€å¤šä½™å­—æ®µã€ç±»å‹ä¸ç¬¦ã€fallback è¶Šæƒ

### 6. æ¨¡æ¿ä¸å¯¼å‡ºæ¨¡å—ï¼ˆå¯é€‰ï¼‰

- `render_register_macro()`ï¼šç”Ÿæˆ Rust å­—æ®µæ³¨å†Œæ¨¡æ¿ä»£ç 
- `render_ui_schema()`ï¼šç”Ÿæˆ JSON schema for UI
- `render_dto()`ï¼šç”Ÿæˆ TypeScriptã€Dart æˆ– Rust DTO ç±»å‹ç»“æ„

---

## ğŸ§± å››ã€å­—æ®µå¤„ç†å¼€å‘æµç¨‹

### Step-by-step å·¥ä½œæµï¼š

1. ä½¿ç”¨ Apidom åŠ è½½ `2022-10-07` schema â†’ Element AST
2. è§£å¼•ç”¨ schema ä¸­æ‰€æœ‰ `$ref`
3. æå–æŸä¸ªç±»å‹ï¼ˆå¦‚ Encodingï¼‰çš„å­—æ®µç»“æ„ä¸º `Vec<FieldSpec>`
4. è‡ªåŠ¨ç”Ÿæˆ `register_fixed_fields!` æ¨¡æ¿ä»£ç 
5. å¼€å‘è€…å¡«å†™æ¯ä¸ªå­—æ®µçš„å¤„ç†é€»è¾‘ï¼ˆhandler å‡½æ•°ä½“ï¼‰
6. æ„å»ºå™¨ä¸­ä½¿ç”¨ç»Ÿä¸€åˆ†å‘æœºåˆ¶è‡ªåŠ¨è°ƒç”¨ handler
7. å¯é€‰æ¯”å¯¹å­—æ®µä¸€è‡´æ€§ï¼Œæˆ–å¯¼å‡ºè¡¨å•ç»“æ„ / ç±»å‹å£°æ˜

---

## ğŸ§© ç¤ºä¾‹ä»£ç æ¨¡æ¿

```rust
register_fixed_fields!(EncodingElement, {
    // contentType: string
    "contentType" => |val, el, folder| {
        let v = fold_and_convert_string(val, folder)?;
        el.set_content_type(v);
        Some(())
    },
    // headers: object
    "headers" => |val, el, folder| {
        let v = fold_and_convert_object(val, folder)?;
        el.set_headers(v);
        Some(())
    },
});
```

---

## âœ… äº”ã€è®¾è®¡ä¼˜åŠ¿ä¸æ‰©å±•æ€§

| ç‰¹æ€§ | æ”¯æŒ | è¯´æ˜ |
|------|-------|------|
| å¤š Element å¤ç”¨ | âœ… | æ‰€æœ‰æ„å»ºå™¨å…±ç”¨ä¸€å¥—æ³¨å†Œå’Œè°ƒåº¦æœºåˆ¶ |
| Fold æ’ä»¶åŒ– | âœ… | æ‰€æœ‰å­—æ®µæ”¯æŒç»Ÿä¸€æŠ˜å é¢„å¤„ç† |
| å¤šè¯­è¨€æ”¯æŒ | âœ… | å¯ç”Ÿæˆ TypeScript/Dart/Rust ç±»å‹ |
| Schema æ¼”åŒ–é€‚é… | âœ… | è‡ªåŠ¨ä¸ OpenAPI 3.1 ä¿æŒä¸€è‡´ |
| åŠ¨æ€å¯¼å‡º | âœ… | å¯ç”¨äº UI builderã€ä»£ç ç”Ÿæˆã€æ–‡æ¡£ |
| å­—æ®µè¿½è¸ªä¸å…ƒä¿¡æ¯æ³¨å…¥ | âœ… | å¯æ’å…¥ sourceã€specPath ç­‰ metadata

---

## ğŸš§ å…­ã€å¯é€‰æ‹“å±•æ¨¡å—

- `validate_required_fields!` å®ï¼ˆåœ¨è¿è¡Œæ—¶æ£€æŸ¥æ˜¯å¦é—æ¼å¿…å¡«å­—æ®µï¼‰
- `define_element_builder!` å®ï¼ˆç»Ÿä¸€ç”ŸæˆæŸ Element çš„ builder + æ³¨å†Œ + dispatchï¼‰
- `builder_test_suite!`ï¼ˆè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹éªŒè¯å­—æ®µæ„å»ºå®Œæ•´æ€§ï¼‰

---

## ğŸ§­ ä¸ƒã€å…¸å‹ä½¿ç”¨è·¯å¾„

| åœºæ™¯ | åŠ¨ä½œ |
|------|------|
| æƒ³å®ç°ä¸€ä¸ªæ–° Element æ„å»ºå™¨ | æå– schema â†’ è‡ªåŠ¨ç”Ÿæˆå­—æ®µæ¨¡æ¿ â†’ å†™ handler |
| æƒ³éªŒè¯ç°æœ‰ builder ä¸ schema ä¸€è‡´ | æ¯”å¯¹ schema å­—æ®µä¸æ³¨å†Œå­—æ®µ |
| æƒ³ç”Ÿæˆ UI é…ç½®è¡¨å•ç»“æ„ | ä» FieldSpec è¾“å‡º JSON schema |
| æƒ³æ”¯æŒ TS ç±»å‹å¯¼å‡º | æ¸²æŸ“ DTO ç»“æ„ä½“æ¨¡æ¿ |
| æƒ³æ’å…¥ Fold AST æ“ä½œ | æ‰€æœ‰ handler ç»Ÿä¸€æ¥æ”¶ `&mut Fold` |

---

## âœ… å…«ã€æ€»ç»“

æœ¬ç³»ç»Ÿæä¾›äº†ä¸€å¥—å¯å¤ç”¨ã€ç»“æ„é©±åŠ¨ã€å®Œå…¨å¯æ‰©å±•çš„å­—æ®µæ³¨å†Œä¸æ„å»ºå™¨è°ƒåº¦æœºåˆ¶ã€‚å®ƒå…¼å®¹ Apidom çš„ Element AST ä¸ Fold æ¶æ„ï¼ŒåŒæ—¶å…·å¤‡ï¼š

- è‡ªåŠ¨ç»“æ„æå–
- ç»Ÿä¸€æ³¨å†Œç®¡ç†
- æ„å»ºé€»è¾‘åˆ†å‘
- Schema å¯¹é½éªŒè¯
- å…ƒæ•°æ®è¿½è¸ªæ³¨å…¥
- UI ä¸ä»£ç ç”Ÿæˆæ”¯æ’‘

æœªæ¥å¯ä»¥ä½œä¸º Apidom / Stepflow / OpenAPI ç³»ç»Ÿçš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œæ”¯æŒ DSLã€AI Schemaã€æ’ä»¶ç³»ç»Ÿç­‰è¿›ä¸€æ­¥æ‰©å±•ã€‚